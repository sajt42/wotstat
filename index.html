<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WOTStat – Community Progress</title>
  <style>
        .profile-mainstat {
          font-size: 40px;
          font-weight: 700;
          color: var(--accent2);
          margin: 12px 0;
        }
        .profile-label {
          font-size: 18px;
          font-weight: 600;
          color: var(--accent1);
          margin-bottom: 2px;
        }
    :root {
      --bg: #111;
      --fg: #eee;
      --accent1: #ff4b8b;
      --accent2: #ffb347;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    .wrapper {
      width: 90%;
      max-width: 800px;
      text-align: center;
    }
    .logo { margin-bottom: 10px; }
    .logo img {
      max-width: 240px;
      height: auto;
      opacity: 0.95;
    }
    h1 {
      margin: 0 0 30px 0;
      font-size: 32px;
      letter-spacing: 1px;
    }
    #progress-container {
      width: 100%;
      margin: 0 auto 25px auto;
      border: 1px solid #555;
      border-radius: 8px;
      background: #222;
      overflow: hidden;
    }
    #progress-bar {
      height: 40px;
      width: 0%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 0.5s ease;
    }
    #numbers {
      margin-top: 20px;
      line-height: 1.3;
    }
    #current-total {
      font-size: 40px;
      font-weight: 700;
    }
    #percent {
      font-size: 32px;
      font-weight: 600;
      color: var(--accent2);
    }
    #status {
      margin-top: 15px;
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="logo">
      <img id="logo-global" src="static/wotr_logo.jpg" alt="World of Trucks logo" style="display:none;max-width:240px;height:auto;">
      <img id="logo-ets2" src="static/ets2.jpg" alt="ETS2 logo" style="display:none;max-width:240px;height:auto;">
      <img id="logo-ats" src="static/ats.jpeg" alt="ATS logo" style="display:none;max-width:240px;height:auto;">
      <img id="logo-wotr" src="static/wotr_logo.jpg" alt="World of Trucks logo" style="display:none;max-width:240px;height:auto;">
    </div>
    <h1 id="screen-title">Loading...</h1>
    <div id="progress-container" style="display:none;">
      <div id="progress-bar"></div>
    </div>
    <div id="numbers" style="display:none;">
      <div id="current-total"></div>
      <div id="percent"></div>
    </div>
    <div id="profile-info" style="display:none;"></div>
      <div id="profile-global" style="display:none;"></div>
      <div id="profile-ets2" style="display:none;"></div>
      <div id="profile-ats" style="display:none;"></div>
    <div id="status"></div>
    <div style="margin-top:30px;">
      
    </div>
  </div>
  <script>
    // All config and state
    let API_BASE = '';
    let REFRESH_MS = 15000;
    let SCREEN_SWITCH_SECONDS = 10;
    let ENABLE_COMMUNITY = true;
    let ENABLE_USER = true;
    let ENABLE_PROFILE = true;
    let currentScreen = 'community';
    let switchTimer = null;

    async function loadConfig() {
      try {
        const resp = await fetch('/config');
        const cfg = await resp.json();
        const port = cfg.server_port || 8001;
        const host = window.location.hostname;
        API_BASE = `http://${host}:${port}`;
        REFRESH_MS = cfg.refresh_ms || 15000;
        SCREEN_SWITCH_SECONDS = cfg.screen_switch_seconds || 10;
        ENABLE_COMMUNITY = cfg.screen_community !== false;
        ENABLE_USER = cfg.screen_user !== false;
        ENABLE_PROFILE = cfg.screen_profile !== false;
        document.getElementById('btn-community').style.display = ENABLE_COMMUNITY ? '' : 'none';
        document.getElementById('btn-user').style.display = ENABLE_USER ? '' : 'none';
        document.getElementById('btn-profile').style.display = ENABLE_PROFILE ? '' : 'none';
      } catch (e) {
        API_BASE = '';
        REFRESH_MS = 15000;
        SCREEN_SWITCH_SECONDS = 10;
        ENABLE_COMMUNITY = ENABLE_USER = ENABLE_PROFILE = true;
      }
    }

    function showScreen(screen) {
      currentScreen = screen;
      clearTimeout(switchTimer);
      // Minden screen elrejtése
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('numbers').style.display = 'none';
      document.getElementById('profile-global').style.display = 'none';
      document.getElementById('profile-ets2').style.display = 'none';
      document.getElementById('profile-ats').style.display = 'none';
      document.getElementById('logo-global').style.display = 'none';
      document.getElementById('logo-ets2').style.display = 'none';
      document.getElementById('logo-ats').style.display = 'none';
      document.getElementById('logo-wotr').style.display = 'none';
      document.getElementById('status').textContent = '';

      // Új screens logika
      // 1 userglobal(1), 2 userglobal(2), 3 ce global, 4 userevent, 5 ets2(1), 6 ets2(2), 7 ATS(1), 8 ATS(2)
      // A screen nevek: userglobal1, userglobal2, ceglobal, userevent, ets2_1, ets2_2, ats_1, ats_2
      switch (screen) {
        case 'userglobal1':
          document.getElementById('profile-global').style.display = '';
          document.getElementById('logo-global').style.display = '';
          fetchProfileStats('global', 1);
          break;
        case 'userglobal2':
          document.getElementById('profile-global').style.display = '';
          document.getElementById('logo-global').style.display = '';
          fetchProfileStats('global', 2);
          break;
        case 'ceglobal':
          document.getElementById('progress-container').style.display = '';
          document.getElementById('numbers').style.display = '';
          document.getElementById('logo-wotr').style.display = '';
          fetchCommunity();
          break;
        case 'userevent':
          document.getElementById('progress-container').style.display = '';
          document.getElementById('numbers').style.display = '';
          document.getElementById('logo-wotr').style.display = '';
          fetchUser();
          break;
        case 'ets2_1':
          document.getElementById('profile-ets2').style.display = '';
          document.getElementById('logo-ets2').style.display = '';
          fetchProfileStats('ets2', 1);
          break;
        case 'ets2_2':
          document.getElementById('profile-ets2').style.display = '';
          document.getElementById('logo-ets2').style.display = '';
          fetchProfileStats('ets2', 2);
          break;
        case 'ats_1':
          document.getElementById('profile-ats').style.display = '';
          document.getElementById('logo-ats').style.display = '';
          fetchProfileStats('ats', 1);
          break;
        case 'ats_2':
          document.getElementById('profile-ats').style.display = '';
          document.getElementById('logo-ats').style.display = '';
          fetchProfileStats('ats', 2);
          break;
      }

      // Az engedélyezett screens tömb
      let screens = [];
      if (ENABLE_PROFILE) {
        screens.push('userglobal1');
        screens.push('userglobal2');
      }
      if (ENABLE_COMMUNITY) screens.push('ceglobal');
      if (ENABLE_USER) screens.push('userevent');
      if (ENABLE_PROFILE) {
        screens.push('ets2_1');
        screens.push('ets2_2');
        screens.push('ats_1');
        screens.push('ats_2');
      }
      if (screens.length > 1) {
        let idx = screens.indexOf(screen);
        switchTimer = setTimeout(() => {
          showScreen(screens[(idx+1)%screens.length]);
        }, SCREEN_SWITCH_SECONDS * 1000);
      }
    }

    async function fetchCommunity() {
      document.getElementById('screen-title').textContent = 'Community Event Progress';
      document.getElementById('profile-info').innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/community_progress');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        updateProgress(data.event_name || 'Community Event', data.current, data.total, data.percent);
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updateProgress('Community Event', null, null, null);
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
    async function fetchUser() {
      document.getElementById('screen-title').textContent = 'User Event Progress';
      document.getElementById('profile-info').innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/user_progress');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        updateProgress(data.event_name || 'User Event', data.current, data.total, data.percent);
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updateProgress('User Event', null, null, null);
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
    async function fetchProfileStats(type) {
      // Új szétbontás: 1. képernyőn jobs, time, mass, total_distance nagyban; 2. képernyőn nagy avgdist, longest, többi kicsiben
      let screenIndex = arguments.length > 1 ? arguments[1] : 1;
      // Nem kell cím a profil stat képernyőkre
      document.getElementById('screen-title').textContent = '';
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('numbers').style.display = 'none';
      try {
        const resp = await fetch(API_BASE + '/profile_stats');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        let html = '';
        if (data.profile && data.profile[type]) {
          // 1. képernyő: jobs, time, mass, total_distance
          const mainStats1 = ['jobs_accomplished', 'time_on_duty', 'total_mass_transported', 'total_distance'];
          // 2. képernyő: average_delivery_distance, longest_delivery, többi kicsiben
          const mainStats2 = ['average_delivery_distance', 'longest_delivery'];
          if (screenIndex === 1) {
            html += '<div style="margin-bottom:20px;">';
            for (const key of mainStats1) {
              if (data.profile[type][key]) {
                html += `<div class="profile-label">${key.replace(/_/g, ' ').toUpperCase()}</div>`;
                html += `<div class="profile-mainstat">${data.profile[type][key]}</div>`;
              }
            }
            html += '</div>';
          } else {
            // Két oszlopos nagy statok: longest balra, avg jobbra, ne legyen felül külön avg nagyban
            html += '<div style="display:flex;justify-content:center;gap:30px;margin-bottom:20px;">';
            // Longest balra, a mellék statokból ('longest job completed')
            let longestValue = data.profile[type]['longest_job_completed'] || '';
            html += '<div style="flex:1;min-width:0;">';
            html += `<div class="profile-label" style="font-size:22px;">LONGEST JOB COMPLETED</div>`;
            html += `<div class="profile-mainstat">${longestValue || '-'}</div>`;
            html += '</div>';
            // Avg jobbra
            if (data.profile[type]['average_delivery_distance']) {
              html += '<div style="flex:1;min-width:0;">';
              html += `<div class="profile-label" style="font-size:22px;">AVERAGE DELIVERY DISTANCE</div>`;
              html += `<div class="profile-mainstat">${data.profile[type]['average_delivery_distance']}</div>`;
              html += '</div>';
            } else {
              html += '<div style="flex:1;min-width:0;"></div>';
            }
            html += '</div>';
            // Mellék statok: minden, ami nem mainStats1, nem mainStats2, nem 'longest_delivery', és nem 'longest_job_completed'
            html += '<div style="font-size:20px;margin-top:10px;">';
            for (const key in data.profile[type]) {
              if (!mainStats1.includes(key) && !mainStats2.includes(key) && key !== 'longest_delivery' && key !== 'longest_job_completed') {
                html += `<div><b>${key.replace(/_/g, ' ')}:</b> ${data.profile[type][key]}</div>`;
              }
            }
            html += '</div>';
          }
        } else {
          html = 'No profile data.';
        }
        document.getElementById(`profile-${type}`).innerHTML = html;
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById(`profile-${type}`).innerHTML = 'Error: ' + e.message;
        document.getElementById('status').textContent = '';
      }
    }
    function updateProgress(title, current, total, percent) {
      document.getElementById('screen-title').textContent = title;
      const bar = document.getElementById('progress-bar');
      const curTot = document.getElementById('current-total');
      const percentEl = document.getElementById('percent');
      if (current != null && total != null && percent != null) {
        bar.style.width = percent.toFixed(2) + '%';
        curTot.textContent = `${current.toLocaleString('en-US')} / ${total.toLocaleString('en-US')}`;
        percentEl.textContent = percent.toFixed(2) + ' %';
      } else {
        bar.style.width = '0%';
        curTot.textContent = 'No data';
        percentEl.textContent = '';
      }
    }
    // Gombok már nincsenek, ne állítsunk onclick-et
    async function main() {
      await loadConfig();
      // Az első screen mindig userglobal1, ha engedélyezve van
      if (ENABLE_PROFILE) {
        showScreen('userglobal1');
      } else if (ENABLE_COMMUNITY) {
        showScreen('ceglobal');
      } else if (ENABLE_USER) {
        showScreen('userevent');
      }
    }
    main();
  </script>
</body>
</html>
