<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WOTStat â€“ Community Progress</title>
  <style>
    :root {
      --bg: #111;
      --fg: #eee;
      --accent1: #ff4b8b;
      --accent2: #ffb347;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    .wrapper {
      width: 90%;
      max-width: 800px;
      text-align: center;
    }
    .logo { margin-bottom: 10px; }
    .logo img {
      max-width: 240px;
      height: auto;
      opacity: 0.95;
    }
    h1 {
      margin: 0 0 30px 0;
      font-size: 32px;
      letter-spacing: 1px;
    }
    #progress-container {
      width: 100%;
      margin: 0 auto 25px auto;
      border: 1px solid #555;
      border-radius: 8px;
      background: #222;
      overflow: hidden;
    }
    #progress-bar {
      height: 40px;
      width: 0%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 0.5s ease;
    }
    #numbers {
      margin-top: 20px;
      line-height: 1.3;
    }
    #current-total {
      font-size: 40px;
      font-weight: 700;
    }
    #percent {
      font-size: 32px;
      font-weight: 600;
      color: var(--accent2);
    }
    #status {
      margin-top: 15px;
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="logo">
      <img src="wotr_logo.jpg" alt="World of Trucks logo">
    </div>
    <h1 id="screen-title">Loading...</h1>
    <div id="progress-container" style="display:none;">
      <div id="progress-bar"></div>
    </div>
    <div id="numbers" style="display:none;">
      <div id="current-total"></div>
      <div id="percent"></div>
    </div>
    <div id="profile-info" style="display:none;"></div>
    <div id="status"></div>
    <div style="margin-top:30px;">
      <button id="btn-community" style="display:none;">Community Event</button>
      <button id="btn-user" style="display:none;">User Event</button>
      <button id="btn-profile" style="display:none;">Profile Stats</button>
    </div>
  </div>
  <script>
    // All config and state
    let API_BASE = '';
    let REFRESH_MS = 15000;
    let SCREEN_SWITCH_SECONDS = 10;
    let ENABLE_COMMUNITY = true;
    let ENABLE_USER = true;
    let ENABLE_PROFILE = true;
    let currentScreen = 'community';
    let switchTimer = null;

    async function loadConfig() {
      try {
        const resp = await fetch('/config');
        const cfg = await resp.json();
        const port = cfg.server_port || 8001;
        const host = window.location.hostname;
        API_BASE = `http://${host}:${port}`;
        REFRESH_MS = cfg.refresh_ms || 15000;
        SCREEN_SWITCH_SECONDS = cfg.screen_switch_seconds || 10;
        ENABLE_COMMUNITY = cfg.screen_community !== false;
        ENABLE_USER = cfg.screen_user !== false;
        ENABLE_PROFILE = cfg.screen_profile !== false;
        document.getElementById('btn-community').style.display = ENABLE_COMMUNITY ? '' : 'none';
        document.getElementById('btn-user').style.display = ENABLE_USER ? '' : 'none';
        document.getElementById('btn-profile').style.display = ENABLE_PROFILE ? '' : 'none';
      } catch (e) {
        API_BASE = '';
        REFRESH_MS = 15000;
        SCREEN_SWITCH_SECONDS = 10;
        ENABLE_COMMUNITY = ENABLE_USER = ENABLE_PROFILE = true;
      }
    }

    function showScreen(screen) {
      currentScreen = screen;
      clearTimeout(switchTimer);
      document.getElementById('progress-container').style.display = (screen === 'community' || screen === 'user') ? '' : 'none';
      document.getElementById('numbers').style.display = (screen === 'community' || screen === 'user') ? '' : 'none';
      document.getElementById('profile-info').style.display = (screen === 'profile') ? '' : 'none';
      document.getElementById('status').textContent = '';
      if (screen === 'community') fetchCommunity();
      if (screen === 'user') fetchUser();
      if (screen === 'profile') fetchProfile();
      // Auto-switch
      let screens = [];
      if (ENABLE_COMMUNITY) screens.push('community');
      if (ENABLE_USER) screens.push('user');
      if (ENABLE_PROFILE) screens.push('profile');
      if (screens.length > 1) {
        let idx = screens.indexOf(screen);
        switchTimer = setTimeout(() => {
          showScreen(screens[(idx+1)%screens.length]);
        }, SCREEN_SWITCH_SECONDS * 1000);
      }
    }

    async function fetchCommunity() {
      document.getElementById('screen-title').textContent = 'Community Event Progress';
      document.getElementById('profile-info').innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/community_progress');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        updateProgress(data.event_name || 'Community Event', data.current, data.total, data.percent);
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updateProgress('Community Event', null, null, null);
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
    async function fetchUser() {
      document.getElementById('screen-title').textContent = 'User Event Progress';
      document.getElementById('profile-info').innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/user_progress');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        updateProgress(data.event_name || 'User Event', data.current, data.total, data.percent);
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updateProgress('User Event', null, null, null);
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
    async function fetchProfile() {
      document.getElementById('screen-title').textContent = 'Profile Statistics';
      document.getElementById('progress-container').style.display = 'none';
      document.getElementById('numbers').style.display = 'none';
      try {
        const resp = await fetch(API_BASE + '/profile_stats');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        let html = '';
        if (data.profile) {
          html += `<div><b>Username:</b> ${data.profile.username || ''}</div>`;
          if (data.profile.avatar_url) html += `<div><img src="${data.profile.avatar_url}" alt="Avatar" style="max-width:120px;border-radius:8px;"></div>`;
          if (data.profile.completed_events && data.profile.completed_events.length) {
            html += '<div><b>Completed Events:</b><ul>';
            for (const ev of data.profile.completed_events) html += `<li>${ev}</li>`;
            html += '</ul></div>';
          }
        }
        document.getElementById('profile-info').innerHTML = html || 'No profile data.';
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        document.getElementById('profile-info').innerHTML = 'Error: ' + e.message;
        document.getElementById('status').textContent = '';
      }
    }
    function updateProgress(title, current, total, percent) {
      document.getElementById('screen-title').textContent = title;
      const bar = document.getElementById('progress-bar');
      const curTot = document.getElementById('current-total');
      const percentEl = document.getElementById('percent');
      if (current != null && total != null && percent != null) {
        bar.style.width = percent.toFixed(2) + '%';
        curTot.textContent = `${current.toLocaleString('en-US')} / ${total.toLocaleString('en-US')}`;
        percentEl.textContent = percent.toFixed(2) + ' %';
      } else {
        bar.style.width = '0%';
        curTot.textContent = 'No data';
        percentEl.textContent = '';
      }
    }
    document.getElementById('btn-community').onclick = () => showScreen('community');
    document.getElementById('btn-user').onclick = () => showScreen('user');
    document.getElementById('btn-profile').onclick = () => showScreen('profile');
    async function main() {
      await loadConfig();
      if (ENABLE_COMMUNITY) showScreen('community');
      else if (ENABLE_USER) showScreen('user');
      else if (ENABLE_PROFILE) showScreen('profile');
    }
    main();
  </script>
</body>
</html>
