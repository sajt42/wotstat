<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WOTStat – Community Progress</title>
  <style>
        .profile-mainstat {
          font-size: 40px;
          font-weight: 700;
          color: var(--accent2);
          margin: 12px 0;
        }
        .profile-label {
          font-size: 18px;
          font-weight: 600;
          color: var(--accent1);
          margin-bottom: 2px;
        }
    :root {
      --bg: #111;
      --fg: #eee;
      --accent1: #ff4b8b;
      --accent2: #ffb347;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    .wrapper {
      width: 90%;
      max-width: 800px;
      text-align: center;
    }
    .logo { margin-bottom: 10px; }
    .logo img {
      max-width: 240px;
      height: auto;
      opacity: 0.95;
    }
    h1 {
      margin: 0 0 30px 0;
      font-size: 32px;
      letter-spacing: 1px;
    }
    #progress-container {
      width: 100%;
      margin: 0 auto 25px auto;
      border: 1px solid #555;
      border-radius: 8px;
      background: #222;
      overflow: hidden;
    }
    #progress-bar {
      height: 40px;
      width: 0%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 0.5s ease;
    }
    #numbers {
      margin-top: 20px;
      line-height: 1.3;
    }
    #current-total {
      font-size: 40px;
      font-weight: 700;
    }
    #percent {
      font-size: 32px;
      font-weight: 600;
      color: var(--accent2);
    }
    #status {
      margin-top: 15px;
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="logo">
      <img id="logo-global" src="static/wotr_logo.jpg" alt="World of Trucks logo" style="display:none;max-width:240px;height:auto;">
      <img id="logo-ets2" src="static/ets2.jpg" alt="ETS2 logo" style="display:none;max-width:240px;height:auto;">
      <img id="logo-ats" src="static/ats.jpeg" alt="ATS logo" style="display:none;max-width:240px;height:auto;">
      <img id="logo-wotr" src="static/wotr_logo.jpg" alt="World of Trucks logo" style="display:none;max-width:240px;height:auto;">
    </div>
    <h1 id="screen-title"></h1>
    <div id="progress-container" style="display:none;">
      <div id="progress-bar"></div>
    </div>
    <div id="numbers" style="display:none;">
      <div id="current-total"></div>
      <div id="percent"></div>
    </div>
    <div id="profile-info" style="display:none;"></div>
    <div id="profile-global" style="display:none;"></div>
    <div id="profile-ets2" style="display:none;"></div>
    <div id="profile-ats" style="display:none;"></div>
    <div id="username" style="font-size:13px;color:#aaa;margin-top:10px;"></div>
    <div id="status"></div>
    <div style="margin-top:30px;">
      
    </div>
  </div>
  <script>
    // All config and state
    let API_BASE = '';
    let REFRESH_MS = 15000;
    let SCREEN_SWITCH_SECONDS = 10;
    let ENABLE_COMMUNITY = true;
    let ENABLE_USER = true;
    let ENABLE_PROFILE_GLOBAL = true;
    let ENABLE_PROFILE_ETS2 = true;
    let ENABLE_PROFILE_ATS = true;
    let currentScreen = 'community';
    let switchTimer = null;
    let screens = [];

    function buildScreens() {
      screens = [];
      if (ENABLE_PROFILE_GLOBAL) {
        screens.push('userglobal1');
        screens.push('userglobal2');
      }
      if (ENABLE_COMMUNITY) screens.push('ceglobal');
      if (ENABLE_USER) screens.push('userevent');
      if (ENABLE_PROFILE_ETS2) {
        screens.push('ets2_1');
        screens.push('ets2_2');
      }
      if (ENABLE_PROFILE_ATS) {
        screens.push('ats_1');
        screens.push('ats_2');
      }
    }

    async function loadConfig() {
        try {
            const resp = await fetch('/config');
            const cfg = await resp.json();
            const port = cfg.server_port || 8001;
            const host = window.location.hostname;
            API_BASE = `http://${host}:${port}`;
            REFRESH_MS = cfg.refresh_ms || 15000;
            SCREEN_SWITCH_SECONDS = cfg.screen_switch_seconds || 10;
            ENABLE_COMMUNITY = cfg.screen_community === true;
            ENABLE_USER = cfg.screen_user === true;
            ENABLE_PROFILE_GLOBAL = cfg.screen_profile_global === true;
            ENABLE_PROFILE_ETS2 = cfg.screen_profile_ets2 === true;
            ENABLE_PROFILE_ATS = cfg.screen_profile_ats === true;
            if (document.getElementById('btn-community')) document.getElementById('btn-community').style.display = ENABLE_COMMUNITY ? '' : 'none';
            if (document.getElementById('btn-user')) document.getElementById('btn-user').style.display = ENABLE_USER ? '' : 'none';
            const hasAnyProfile = ENABLE_PROFILE_GLOBAL || ENABLE_PROFILE_ETS2 || ENABLE_PROFILE_ATS;
            if (document.getElementById('btn-profile')) document.getElementById('btn-profile').style.display = hasAnyProfile ? '' : 'none';

            // Remove stat screen DOM elements if not enabled in config
            if (!ENABLE_PROFILE_GLOBAL && document.getElementById('profile-global')) document.getElementById('profile-global').remove();
            if (!ENABLE_PROFILE_ETS2 && document.getElementById('profile-ets2')) document.getElementById('profile-ets2').remove();
            if (!ENABLE_PROFILE_ATS && document.getElementById('profile-ats')) document.getElementById('profile-ats').remove();

            buildScreens();
            if (screens.length > 0) {
              showScreen(screens[0]);
            } else {
              showScreen(null);
            }
        } catch (e) {
            API_BASE = '';
            REFRESH_MS = 15000;
            SCREEN_SWITCH_SECONDS = 10;
            ENABLE_COMMUNITY = ENABLE_USER = ENABLE_PROFILE_GLOBAL = ENABLE_PROFILE_ETS2 = ENABLE_PROFILE_ATS = true;
        }
    }

    function showScreen(screen) {
      currentScreen = screen;
      clearTimeout(switchTimer);
      // Minden screen elrejtése
      if (document.getElementById('progress-container')) document.getElementById('progress-container').style.display = 'none';
      if (document.getElementById('numbers')) document.getElementById('numbers').style.display = 'none';
      if (document.getElementById('profile-global')) {
        document.getElementById('profile-global').style.display = 'none';
        document.getElementById('profile-global').innerHTML = '';
      }
      if (document.getElementById('profile-ets2')) {
        document.getElementById('profile-ets2').style.display = 'none';
        document.getElementById('profile-ets2').innerHTML = '';
      }
      if (document.getElementById('profile-ats')) {
        document.getElementById('profile-ats').style.display = 'none';
        document.getElementById('profile-ats').innerHTML = '';
      }
      if (document.getElementById('logo-global')) document.getElementById('logo-global').style.display = 'none';
      if (document.getElementById('logo-ets2')) document.getElementById('logo-ets2').style.display = 'none';
      if (document.getElementById('logo-ats')) document.getElementById('logo-ats').style.display = 'none';
      if (document.getElementById('logo-wotr')) document.getElementById('logo-wotr').style.display = 'none';
      if (document.getElementById('status')) document.getElementById('status').textContent = '';

      // Új screens logika
      // 1 userglobal(1), 2 userglobal(2), 3 ce global, 4 userevent, 5 ets2(1), 6 ets2(2), 7 ATS(1), 8 ATS(2)
      // A screen nevek: userglobal1, userglobal2, ceglobal, userevent, ets2_1, ets2_2, ats_1, ats_2
      // Csak akkor hajtunk végre DOM műveletet, ha a screens tömb tartalmazza a screen-t
      if (screens.includes(screen)) {
        switch (screen) {
          case 'userglobal1':
            if (document.getElementById('profile-global')) {
              document.getElementById('profile-global').style.display = 'none';
              if (document.getElementById('logo-global')) document.getElementById('logo-global').style.display = '';
              setTimeout(() => fetchProfileStats('global', 1), 50);
            }
            break;
          case 'userglobal2':
            if (document.getElementById('profile-global')) {
              document.getElementById('profile-global').style.display = 'none';
              if (document.getElementById('logo-global')) document.getElementById('logo-global').style.display = '';
              setTimeout(() => fetchProfileStats('global', 2), 50);
            }
            break;
          case 'ceglobal':
            if (document.getElementById('progress-container')) document.getElementById('progress-container').style.display = '';
            if (document.getElementById('numbers')) document.getElementById('numbers').style.display = '';
            if (document.getElementById('logo-wotr')) document.getElementById('logo-wotr').style.display = '';
            fetchCommunity();
            break;
          case 'userevent':
            if (document.getElementById('progress-container')) document.getElementById('progress-container').style.display = '';
            if (document.getElementById('numbers')) document.getElementById('numbers').style.display = '';
            if (document.getElementById('logo-wotr')) document.getElementById('logo-wotr').style.display = '';
            fetchUser();
            break;
          case 'ets2_1':
            if (document.getElementById('profile-ets2')) {
              document.getElementById('profile-ets2').style.display = 'none';
              if (document.getElementById('logo-ets2')) document.getElementById('logo-ets2').style.display = '';
              setTimeout(() => fetchProfileStats('ets2', 1), 50);
            }
            break;
          case 'ets2_2':
            if (document.getElementById('profile-ets2')) {
              document.getElementById('profile-ets2').style.display = 'none';
              if (document.getElementById('logo-ets2')) document.getElementById('logo-ets2').style.display = '';
              setTimeout(() => fetchProfileStats('ets2', 2), 50);
            }
            break;
          case 'ats_1':
            if (document.getElementById('profile-ats')) {
              document.getElementById('profile-ats').style.display = 'none';
              if (document.getElementById('logo-ats')) document.getElementById('logo-ats').style.display = '';
              setTimeout(() => fetchProfileStats('ats', 1), 50);
            }
            break;
          case 'ats_2':
            if (document.getElementById('profile-ats')) {
              document.getElementById('profile-ats').style.display = 'none';
              if (document.getElementById('logo-ats')) document.getElementById('logo-ats').style.display = '';
              setTimeout(() => fetchProfileStats('ats', 2), 50);
            }
            break;
        }
      }

      // Ha nincs egyetlen engedélyezett screen sem, jelenjen meg hibaüzenet
      if (screens.length === 0) {
        // Minden stat screen DOM-ot törlünk, és megjelenítünk egy jól látható hibaüzenetet
        const wrapper = document.querySelector('.wrapper');
        if (wrapper) wrapper.innerHTML = '<div style="margin:80px auto;font-size:2rem;color:#ff4b8b;font-weight:bold;">Config error: no screen selected.</div>';
        return;
      }
      if (screens.length > 1) {
        let idx = screens.indexOf(screen);
        switchTimer = setTimeout(() => {
          showScreen(screens[(idx+1)%screens.length]);
        }, SCREEN_SWITCH_SECONDS * 1000);
      }
    }

    async function fetchCommunity() {
      document.getElementById('screen-title').textContent = 'Community Event Progress';
      document.getElementById('profile-info').innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/community_progress');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        updateProgress(data.event_name || 'Community Event', data.current, data.total, data.percent);
        document.getElementById('username').textContent = data.username ? 'user: ' + data.username.toLowerCase() : '';
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updateProgress('Community Event', null, null, null);
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
    async function fetchUser() {
      document.getElementById('screen-title').textContent = 'User Event Progress';
      document.getElementById('profile-info').innerHTML = '';
      try {
        const resp = await fetch(API_BASE + '/user_progress');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        updateProgress(data.event_name || 'User Event', data.current, data.total, data.percent);
        document.getElementById('username').textContent = data.username ? 'user: ' + data.username.toLowerCase() : '';
        document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updateProgress('User Event', null, null, null);
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
    function updateProgress(eventName, current, total, percent) {
      if (document.getElementById('progress-container')) document.getElementById('progress-container').style.display = '';
      if (document.getElementById('numbers')) document.getElementById('numbers').style.display = '';
      const bar = document.getElementById('progress-bar');
      const curTot = document.getElementById('current-total');
      const percentEl = document.getElementById('percent');
      if (bar) bar.style.width = Number.isFinite(percent) ? `${percent}%` : '0%';
      if (curTot) {
        if (Number.isFinite(current) && Number.isFinite(total)) {
          curTot.textContent = `${current.toLocaleString('en-US')} / ${total.toLocaleString('en-US')}`;
        } else {
          curTot.textContent = '-';
        }
      }
      if (percentEl) percentEl.textContent = Number.isFinite(percent) ? `${percent} %` : '';
    }

    async function fetchProfileStats(type, screenIndex = 1) {
      if (document.getElementById('screen-title')) document.getElementById('screen-title').textContent = '';
      if (document.getElementById('progress-container')) document.getElementById('progress-container').style.display = 'none';
      if (document.getElementById('numbers')) document.getElementById('numbers').style.display = 'none';
      try {
        const resp = await fetch(API_BASE + '/profile_stats');
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        const profile = data.profile && data.profile[type];
        if (!profile) throw new Error('profile_not_found');

        const mainStats1 = ['jobs_accomplished', 'time_on_duty', 'total_mass_transported', 'total_distance'];
        const mainStats2 = ['average_delivery_distance', 'longest_job_completed'];

        const containerId = type === 'global' ? 'profile-global' : type === 'ets2' ? 'profile-ets2' : 'profile-ats';
        const logoId = type === 'global' ? 'logo-global' : type === 'ets2' ? 'logo-ets2' : 'logo-ats';
        const container = document.getElementById(containerId);
        if (!container) return;

        let html = '';
        if (screenIndex === 1) {
          for (const key of mainStats1) {
            if (profile[key]) {
              html += `<div class="profile-label">${key.replace(/_/g, ' ').toUpperCase()}</div>`;
              html += `<div class="profile-mainstat">${profile[key]}</div>`;
            }
          }
        } else {
          const longest = profile.longest_job_completed || '-';
          const avg = profile.average_delivery_distance || '-';
          html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:40px;margin-bottom:20px;">';
          html += `<div style="flex:1;text-align:center;"><div class="profile-label">LONGEST DELIVERY</div><div class="profile-mainstat">${longest}</div></div>`;
          html += `<div style="flex:1;text-align:center;"><div class="profile-label">AVERAGE DELIVERY DISTANCE</div><div class="profile-mainstat">${avg}</div></div>`;
          html += '</div>';
          html += '<div style="font-size:20px;margin-top:10px;">';
          for (const key of Object.keys(profile)) {
            if (mainStats1.includes(key) || mainStats2.includes(key)) continue;
            html += `<div>${key.replace(/_/g, ' ').toUpperCase()}: ${profile[key]}</div>`;
          }
          html += '</div>';
        }

        container.innerHTML = html;
        container.style.display = '';
        if (document.getElementById(logoId)) document.getElementById(logoId).style.display = '';
        if (document.getElementById('status')) document.getElementById('status').textContent = 'Last update: ' + new Date().toLocaleTimeString();
      } catch (e) {
        if (document.getElementById('status')) document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }
  </script>
  <script>
    window.addEventListener('DOMContentLoaded', loadConfig);
  </script>
</body>
</html>

